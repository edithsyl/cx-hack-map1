<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Display a popup on hover</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.6.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.6.0/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js"></script>
    <script src="../dist/threebox.js" type="text/javascript"></script>
    <link href="../dist/threebox.css" rel="stylesheet" />
    <script src="config.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <style>
      .mapboxgl-popup {
        max-width: 400px;
        font: 12px/20px "Helvetica Neue", Arial, Helvetica, sans-serif;
      }
    </style>
    <div id="map"></div>
    <script type="module">
      if (!config)
        console.error(
          "Config not set! Make a copy of 'config_template.js', add in your access token, and save the file as 'config.js'."
        );

      mapboxgl.accessToken =
        "pk.eyJ1IjoiZWRpdGhsIiwiYSI6ImNrdnhjemM0dDAwankzMG50MzYxOWcyNTMifQ.STT_KO4enGmW0-lKvG8LYQ";
      var origin = [114.04444, 22.31311, 0];
      var origin_arr = [
        [114.04444, 22.31311],
        [114.17082, 22.31812],
        [114.15565, 22.28098],
        [114.1746, 22.24707],
        [114.17013, 22.30716],
        [114.14989, 22.27126],
        [114.17698, 22.29615],
        [114.30095, 22.37749],
        [114.1698968, 22.29948746],
        [114.0102478, 22.44544347],
      ];

      var map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/light-v9",
        center: origin,
        zoom: 12.5,
        pitch: 60,
        bearing: 80,
        antialias: true,
      });

      // we can add Threebox to mapbox to add built-in mouseover/mouseout and click behaviors
      window.tb = new Threebox(map, map.getCanvas().getContext("webgl"), {
        defaultLights: true,
      });
      let stats;
      import Stats from "https://threejs.org/examples/jsm/libs/stats.module.js";
      function animate() {
        requestAnimationFrame(animate);
        stats.update();
      }

      map.on("style.load", (e) => {
        // stats
        stats = new Stats();
        map.getContainer().appendChild(stats.dom);
        animate();

        map.addSource("places", {
          type: "geojson",
          data: {
            type: "FeatureCollection",
            features: [
              {
                type: "Feature",
                properties: {
                  description:
                    "<strong>Make it Mount Pleasant</strong><p>Make it Mount Pleasant is a handmade and vintage market and afternoon of live entertainment and kids activities. 12:00-6:00 p.m.</p>",
                },
                geometry: {
                  type: "Point",
                  coordinates: [114.04444, 22.31311],
                },
              },
              {
                type: "Feature",
                properties: {
                  description:
                    "<strong>Mad Men Season Five Finale Watch Party</strong><p>Head to Lounge 201 (201 Massachusetts Avenue NE) Sunday for a Mad Men Season Five Finale Watch Party, complete with 60s costume contest, Mad Men trivia, and retro food and drink. 8:00-11:00 p.m. $10 general admission, $20 admission and two hour open bar.</p>",
                },
                geometry: {
                  type: "Point",
                  coordinates: [114.17082, 22.31812],
                },
              },
              {
                type: "Feature",
                properties: {
                  description:
                    "<strong>Big Backyard Beach Bash and Wine Fest</strong><p>EatBar (2761 Washington Boulevard Arlington VA) is throwing a Big Backyard Beach Bash and Wine Fest on Saturday, serving up conch fritters, fish tacos and crab sliders, and Red Apron hot dogs. 12:00-3:00 p.m. $25.</p>",
                },
                geometry: {
                  type: "Point",
                  coordinates: [114.15565, 22.28098],
                },
              },
              {
                type: "Feature",
                properties: {
                  description:
                    "<strong>Make it Mount Pleasant</strong><p>Make it Mount Pleasant is a handmade and vintage market and afternoon of live entertainment and kids activities. 12:00-6:00 p.m.</p>",
                },
                geometry: {
                  type: "Point",
                  coordinates: [114.1746, 22.24707],
                },
              },
              {
                type: "Feature",
                properties: {
                  description:
                    "<strong>Mad Men Season Five Finale Watch Party</strong><p>Head to Lounge 201 (201 Massachusetts Avenue NE) Sunday for a Mad Men Season Five Finale Watch Party, complete with 60s costume contest, Mad Men trivia, and retro food and drink. 8:00-11:00 p.m. $10 general admission, $20 admission and two hour open bar.</p>",
                },
                geometry: {
                  type: "Point",
                  coordinates: [114.17013, 22.30716],
                },
              },
              {
                type: "Feature",
                properties: {
                  description:
                    "<strong>Big Backyard Beach Bash and Wine Fest</strong><p>EatBar (2761 Washington Boulevard Arlington VA) is throwing a Big Backyard Beach Bash and Wine Fest on Saturday, serving up conch fritters, fish tacos and crab sliders, and Red Apron hot dogs. 12:00-3:00 p.m. $25.</p>",
                },
                geometry: {
                  type: "Point",
                  coordinates: [114.14989, 22.27126],
                },
              },
              {
                type: "Feature",
                properties: {
                  description:
                    "<strong>Make it Mount Pleasant</strong><p>Make it Mount Pleasant is a handmade and vintage market and afternoon of live entertainment and kids activities. 12:00-6:00 p.m.</p>",
                },
                geometry: {
                  type: "Point",
                  coordinates: [114.17698, 22.29615],
                },
              },
              {
                type: "Feature",
                properties: {
                  description:
                    "<strong>Mad Men Season Five Finale Watch Party</strong><p>Head to Lounge 201 (201 Massachusetts Avenue NE) Sunday for a Mad Men Season Five Finale Watch Party, complete with 60s costume contest, Mad Men trivia, and retro food and drink. 8:00-11:00 p.m. $10 general admission, $20 admission and two hour open bar.</p>",
                },
                geometry: {
                  type: "Point",
                  coordinates: [114.30095, 22.37749],
                },
              },
              {
                type: "Feature",
                properties: {
                  description:
                    "<strong>Big Backyard Beach Bash and Wine Fest</strong><p>EatBar (2761 Washington Boulevard Arlington VA) is throwing a Big Backyard Beach Bash and Wine Fest on Saturday, serving up conch fritters, fish tacos and crab sliders, and Red Apron hot dogs. 12:00-3:00 p.m. $25.</p>",
                },
                geometry: {
                  type: "Point",
                  coordinates: [114.1698968, 22.29948746],
                },
              },
              {
                type: "Feature",
                properties: {
                  description:
                    "<strong>Big Backyard Beach Bash and Wine Fest</strong><p>EatBar (2761 Washington Boulevard Arlington VA) is throwing a Big Backyard Beach Bash and Wine Fest on Saturday, serving up conch fritters, fish tacos and crab sliders, and Red Apron hot dogs. 12:00-3:00 p.m. $25.</p>",
                },
                geometry: {
                  type: "Point",
                  coordinates: [114.0102478, 22.44544347],
                },
              },
            ],
          },
        });
        //Add a layer for showing popup
        map.addLayer({
          id: "places",
          type: "circle",
          source: "places",
          paint: {
            "circle-color": "#4264fb",
            "circle-radius": 6,
            "circle-stroke-width": 2,
            "circle-stroke-color": "#ffffff",
            "circle-opacity": 0.1,
          },
        });

        // 3d logo layer
        map.addLayer({
          id: "custom_layer",
          type: "custom",
          renderingMode: "3d",
          source: "places",
          onAdd: function (map, mbxContext) {
            // import soldier from an external glb file, scaling up its size 20x
            // IMPORTANT: .glb is not a standard MIME TYPE, you'll have to add it to your web server config,
            // otherwise you'll receive a 404 error

            // Attribution: Soldier animated model by T. Choonyung at https://www.mixamo.com
            // from https://www.mixamo.com/#/?page=1&query=vanguard&type=Character
            var options = {
              obj: "./google_map_tag.gltf",
              type: "gltf",
              scale: 2,
              units: "meters",
              rotation: { x: 90, y: 0, z: 0 }, //default rotation
              anchor: "center",
            };
            for (let i = 0; i < 10; i++) {
              tb.loadObj(options, function (model) {
                model.addTooltip("this is an attraction", true);
                let soldier = model.setCoords([
                  origin_arr[i][0],// map.features[0].geometry.coordinates[0],
                  origin_arr[i][1],// map.features[0].geometry.coordinates[1],
                  0,
                ]);
                model.set({
                  rotation: { x: 0, y: 0, z: 7560 },
                  duration: 250000,
                });
                tb.add(soldier);
              });
            }
          },
          render: function (gl, matrix) {
            tb.update();
          },
        });
        //});

        // Create a popup, but don't add it to the map yet.
        const popup = new mapboxgl.Popup({
          closeButton: false,
          closeOnClick: false,
        });

        map.on("mouseenter", "places", (e) => {
          // Change the cursor style as a UI indicator.
          map.getCanvas().style.cursor = "pointer";

          // Copy coordinates array.
          const coordinates = e.features[0].geometry.coordinates.slice();
          const description = e.features[0].properties.description;

          // Ensure that if the map is zoomed out such that multiple
          // copies of the feature are visible, the popup appears
          // over the copy being pointed to.
          while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
          }

          // Populate the popup and set its coordinates
          // based on the feature found.
          popup.setLngLat(coordinates).setHTML(description).addTo(map);
        });

        map.on("mouseleave", "places", () => {
          map.getCanvas().style.cursor = "";
          popup.remove();
        });
      });
    </script>
  </body>
</html>
